{"version":3,"sources":["../../../src/server/lib/source-maps.ts"],"sourcesContent":["// Edge runtime does not implement `module`\nconst findSourceMap =\n  process.env.NEXT_RUNTIME === 'edge'\n    ? () => undefined\n    : (require('module') as typeof import('module')).findSourceMap\n\n/**\n * https://tc39.es/source-map/#index-map\n */\ninterface IndexSourceMapSection {\n  offset: {\n    line: number\n    column: number\n  }\n  map: BasicSourceMapPayload\n}\n\n// TODO(veil): Upstream types\n/** https://tc39.es/ecma426/#sec-index-source-map */\ninterface IndexSourceMap {\n  version: number\n  file: string\n  sections: IndexSourceMapSection[]\n}\n\n/** https://tc39.es/ecma426/#sec-source-map-format */\nexport interface BasicSourceMapPayload {\n  version: number\n  // TODO: Move to https://github.com/jridgewell/sourcemaps which is actively maintained\n  /** WARNING: `file` is optional. */\n  file: string\n  sourceRoot?: string\n  // TODO: Move to https://github.com/jridgewell/sourcemaps which is actively maintained\n  /** WARNING: `sources[number]` can be `null`. */\n  sources: Array<string>\n  names: Array<string>\n  mappings: string\n  ignoreList?: number[]\n}\n\nexport type ModernSourceMapPayload = BasicSourceMapPayload | IndexSourceMap\n\nexport function sourceMapIgnoreListsEverything(\n  sourceMap: BasicSourceMapPayload\n): boolean {\n  return (\n    sourceMap.ignoreList !== undefined &&\n    sourceMap.sources.length === sourceMap.ignoreList.length\n  )\n}\n\n/**\n * Finds the sourcemap payload applicable to a given frame.\n * Equal to the input unless an Index Source Map is used.\n */\nexport function findApplicableSourceMapPayload(\n  line0: number,\n  column0: number,\n  payload: ModernSourceMapPayload\n): BasicSourceMapPayload | undefined {\n  if ('sections' in payload) {\n    if (payload.sections.length === 0) {\n      return undefined\n    }\n\n    // Sections must not overlap and must be sorted: https://tc39.es/source-map/#section-object\n    // Therefore the last section that has an offset less than or equal to the frame is the applicable one.\n    const sections = payload.sections\n    let left = 0\n    let right = sections.length - 1\n    let result: IndexSourceMapSection | null = null\n\n    while (left <= right) {\n      // fast Math.floor\n      const middle = ~~((left + right) / 2)\n      const section = sections[middle]\n      const offset = section.offset\n\n      if (\n        offset.line < line0 ||\n        (offset.line === line0 && offset.column <= column0)\n      ) {\n        result = section\n        left = middle + 1\n      } else {\n        right = middle - 1\n      }\n    }\n\n    return result === null ? undefined : result.map\n  } else {\n    return payload\n  }\n}\n\nconst didWarnAboutInvalidSourceMapDEV = new Set<string>()\n\nexport function filterStackFrameDEV(\n  sourceURL: string,\n  functionName: string,\n  line1: number,\n  column1: number\n): boolean {\n  if (sourceURL === '') {\n    // The default implementation filters out <anonymous> stack frames\n    // but we want to retain them because current Server Components and\n    // built-in Components in parent stacks don't have source location.\n    // Filter out frames that show up in Promises to get good names in React's\n    // Server Request track until we come up with a better heuristic.\n    return (\n      functionName !== 'new Promise' &&\n      functionName !== 'Promise.then' &&\n      functionName !== 'Promise.catch' &&\n      functionName !== 'Promise.finally' &&\n      functionName !== 'Function.withResolvers' &&\n      functionName !== 'Function.all' &&\n      functionName !== 'Function.allSettled'\n    )\n  }\n  if (sourceURL.startsWith('node:') || sourceURL.includes('node_modules')) {\n    return false\n  }\n  try {\n    // Node.js loads source maps eagerly so this call is cheap.\n    // TODO: ESM sourcemaps are O(1) but CommonJS sourcemaps are O(Number of CJS modules).\n    // Make sure this doesn't adversely affect performance when CJS is used by Next.js.\n    const sourceMap = findSourceMap(sourceURL)\n    if (sourceMap === undefined) {\n      // No source map assoicated.\n      // TODO: Node.js types should reflect that `findSourceMap` can return `undefined`.\n      return true\n    }\n    const sourceMapPayload = findApplicableSourceMapPayload(\n      line1 - 1,\n      column1 - 1,\n      sourceMap.payload\n    )\n    if (sourceMapPayload === undefined) {\n      // No source map section applicable to the frame.\n      return true\n    }\n    return !sourceMapIgnoreListsEverything(sourceMapPayload)\n  } catch (cause) {\n    if (process.env.NODE_ENV !== 'production') {\n      // TODO: Share cache with patch-error-inspect\n      if (!didWarnAboutInvalidSourceMapDEV.has(sourceURL)) {\n        didWarnAboutInvalidSourceMapDEV.add(sourceURL)\n        // We should not log an actual error instance here because that will re-enter\n        // this codepath during error inspection and could lead to infinite recursion.\n        console.error(\n          `${sourceURL}: Invalid source map. Only conformant source maps can be used to filter stack frames. Cause: ${cause}`\n        )\n      }\n    }\n\n    return true\n  }\n}\n\nexport function devirtualizeReactServerURL(sourceURL: string): string {\n  if (sourceURL.startsWith('rsc://React/')) {\n    // rsc://React/Server/file://<filename>?42 => file://<filename>\n    const envIdx = sourceURL.indexOf('/', 'rsc://React/'.length)\n    const suffixIdx = sourceURL.lastIndexOf('?')\n    if (envIdx > -1 && suffixIdx > -1) {\n      return decodeURI(sourceURL.slice(envIdx + 1, suffixIdx))\n    }\n  }\n  return sourceURL\n}\n"],"names":["devirtualizeReactServerURL","filterStackFrameDEV","findApplicableSourceMapPayload","sourceMapIgnoreListsEverything","findSourceMap","process","env","NEXT_RUNTIME","undefined","require","sourceMap","ignoreList","sources","length","line0","column0","payload","sections","left","right","result","middle","section","offset","line","column","map","didWarnAboutInvalidSourceMapDEV","Set","sourceURL","functionName","line1","column1","startsWith","includes","sourceMapPayload","cause","NODE_ENV","has","add","console","error","envIdx","indexOf","suffixIdx","lastIndexOf","decodeURI","slice"],"mappings":"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","ignoreList":[0]}